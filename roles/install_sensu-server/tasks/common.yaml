---
- name: Add the official Sensu repository's key
  apt_key: 
    url: http://repos.sensuapp.org/apt/pubkey.gpg 
    state: present

- name: Add the official Sensu repository
  copy:
    src: aptrepo_sensu-server.list
    dest: /etc/apt/sources.list.d/
    backup: yes
  register: aptrepo

- name: Refresh apt cache
  apt: update_cache=yes
  when: aptrepo.changed

- name: Install Sensu, the monitoring framework 
  apt: 
    name: sensu 
    state: present

- name: Set which Ruby to use
  lineinfile:
    dest: /etc/default/sensu
    regexp: ^EMBEDDED_RUBY=
    line: EMBEDDED_RUBY={{ sensu_embedded_ruby }}

- name: Install ruby 
  apt: 
    name: ruby 
    state: present    

- name: Install ruby-dev
  apt: 
    name: ruby-dev 
    state: present 

- name: Install build-essential
  apt: 
    name: build-essential 
    state: present

- name: Create the conf.d/checks directory
  file:
    path: /etc/sensu/conf.d/checks
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rwx,g=rx,o=rx"
    state: directory

- name: Create the standard system checks directory conf.d/checks/standard-system-checks
  file:
    path: /etc/sensu/conf.d/checks/standard-system-checks
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rwx,g=rx,o=rx"
    state: directory

- name: Create the conf.d/clients directory
  file:
    path: /etc/sensu/conf.d/clients
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rwx,g=rx,o=rx"
    state: directory

- name: Create the conf.d/sensu-framework directory
  file:
    path: /etc/sensu/conf.d/sensu-framework
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rwx,g=rx,o=rx"
    state: directory

- name: Create the SSL directory
  file:
    path: /etc/sensu/ssl
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rwx,g=rx,o=rx"
    state: directory
  when: sensu_server_rabbitmq_secure

- name: Copy the SSL certificate & key
  copy:
    src: {{ sensu_cert_dir }}/{{ item }}
    dest: /etc/sensu/ssl/{{ item }}
    owner: "{{ sensu_user }}"
    group: "{{ sensu_group }}"
    mode: "u=rw,g=r"
    backup: yes
  with_items:
    - "{{ sensu_cert_file_name }}"
    - "{{ sensu_key_file_name }}"
  when: sensu_server_rabbitmq_secure

